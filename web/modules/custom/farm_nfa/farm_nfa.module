<?php

/**
 * @file
 * Provides alters and hooks for the farm nfa module.
 */

use Drupal\Component\Serialization\Json;
use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\CloseDialogCommand;
use Drupal\Core\Ajax\MessageCommand;
use Drupal\Core\Ajax\ReplaceCommand;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\farm_nfa\Form\FarmNfaQuantityInlineForm;
use Drupal\log\Entity\LogInterface;

/**
 * Implements hook_entity_type_alter().
 */
function farm_nfa_entity_type_alter(array &$entity_types) {
  /** @var $entity_types \Drupal\Core\Entity\EntityTypeInterface[] */
  $entity_types['plan']->setLinkTemplate('management', '/plan/{plan}/management');
  $entity_types['plan']->setLinkTemplate('budget', '/plan/{plan}/budget');
  $entity_types['plan']->setLinkTemplate('inventory', '/plan/{plan}/inventory');
  $entity_types['plan']->setLinkTemplate('harvest', '/plan/{plan}/harvest');
  $entity_types['quantity']->setHandlerClass('inline_form', FarmNfaQuantityInlineForm::class);
}

/**
 * Implements hook_entity_type_build().
 */
function farm_nfa_entity_type_build(array &$entity_types) {
  /** @var \Drupal\Core\Config\Entity\ConfigEntityType[] $entity_types */
  $entity_types['plan']->setHandlerClass('local_task_provider', ['default' => 'Drupal\farm_nfa\Menu\NfaEntityLocalTaskProvider']);
}

/**
 * Implements hook_css_alter().
 */
function farm_nfa_css_alter(&$css) {
  // Workaround to display the css of the offcanvas dialog in a way Gin/Claro
  // don't mess with the styles.
  $options = \Drupal::routeMatch()->getRouteObject()->getOptions();
  if (isset($options['parameters']) && !empty($options['parameters']['task_route'])) {
    unset($css['core/misc/dialog/off-canvas.base.css']);
    unset($css['core/misc/dialog/off-canvas.button.css']);
    unset($css['core/misc/dialog/off-canvas.css']);
    unset($css['core/misc/dialog/off-canvas.details.css']);
    unset($css['core/misc/dialog/off-canvas.dropbutton.css']);
    unset($css['core/misc/dialog/off-canvas.form.css']);
    unset($css['core/misc/dialog/off-canvas.layout.css']);
    unset($css['core/misc/dialog/off-canvas.motion.css']);
    unset($css['core/misc/dialog/off-canvas.reset.css']);
    unset($css['core/misc/dialog/off-canvas.table.css']);
    unset($css['core/misc/dialog/off-canvas.theme.css']);
  }
}

/**
 * Implements hook_entity_operation_alter().
 */
function farm_nfa_entity_operation_alter(array &$operations, EntityInterface $entity) {
  if (!$entity instanceof LogInterface) {
    return;
  }
  if (!$entity->access('update')) {
    return;
  }
  $options = \Drupal::routeMatch()->getRouteObject()->getOptions();
  if (empty(($options['parameters']))) {
    return;
  }
  $request_stack = \Drupal::requestStack();
  $current_request = $request_stack->getCurrentRequest();
  if (!empty($options['parameters']['task_route']) || $current_request->request->get('_drupal_ajax') == 1) {
    $plan_id = \Drupal::routeMatch()->getRawParameter('plan') ?? \Drupal::service('farm_nfa.referer_plan_loader')->getParameterFromReferer(1);
    $edit_route = $options['parameters']['task_route'] ??  $request_stack->getParentRequest()->query->get('edit_route');;
    $log_types = \Drupal::routeMatch()->getRouteObject()->getDefault('log_types') ?? $request_stack->getParentRequest()->query->get('log_types');
    // Replace the edit operation.
    $operations['edit'] = [
      'title' => t('Edit'),
      'url' => Url::fromRoute($edit_route,
        ['plan' => $plan_id],
        [
          'attributes' => [
            'class' => ['use-ajax'],
            'data-dialog-type' => 'dialog',
            'data-dialog-renderer' => 'off_canvas',
            'data-dialog-options' => Json::encode([
              'width' => '50%',
             ]),
           ],
          'query' => ['log' => $entity->id()]
        ]
      ),
    ];
    // Replace the delete operation.
    if ($operations['delete']) {
      /** @var \Drupal\Core\Url $delete_url */
      $delete_url = $operations['delete']['url'];
      $operations['delete']['url'] = Url::fromRoute(
        $delete_url->getRouteName(),
        $delete_url->getRouteParameters() + ['log_types' => $log_types, 'edit_route' => $edit_route],
        $delete_url->getOptions() + [
          'attributes' => [
            'class' => ['use-ajax'],
            'data-dialog-type' => 'dialog',
            'data-dialog-renderer' => 'off_canvas',
            'data-dialog-options' => Json::encode([
              'width' => '50%',
            ]),
          ],
        ],
      );
    }

  }
}

/**
 * Implements hook_preprocess_menu__toolbar__gin().
 */
function farm_nfa_preprocess_menu__toolbar__gin(&$variables) {
  if (!empty($variables['items'])) {
    // Unset locations menu item.
    if (array_key_exists('farm.locations', $variables['items'])) {
      unset($variables['items']['farm.locations']);
    }
    if (array_key_exists('farm.records', $variables['items']) && !empty($variables['items']['farm.records']['below'])) {
      $records_below = $variables['items']['farm.records']['below'];
      // Unset block and land menu items inside of assets menu.
      if (array_key_exists('views_view:views.farm_asset.page', $records_below) && !empty($records_below['views_view:views.farm_asset.page']['below'])) {
        unset($variables['items']['farm.records']['below']['views_view:views.farm_asset.page']['below']['farm.asset.type:farm.asset.block']);
        unset($variables['items']['farm.records']['below']['views_view:views.farm_asset.page']['below']['farm.asset.type:farm.asset.land']);
      }

      // Unset quantity menu item.
      if (array_key_exists('views_view:views.farm_quantity.page', $records_below)) {
        unset($variables['items']['farm.records']['below']['views_view:views.farm_quantity.page']);
      }
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function farm_nfa_preprocess_block__farm_local_actions_block(&$variables) {
  // Hide action buttons in dashboard page.
  if (\Drupal::routeMatch()->getRouteName() == 'farm.dashboard') {
    $variables['content']['#access'] = FALSE;
  }
}

/**
 * Implements hook_menu_local_actions_alter().
 */
function farm_nfa_menu_local_actions_alter(&$local_actions) {
  unset($local_actions['entity.asset.add_page']);
  unset($local_actions['entity.log.add_page']);
  unset($local_actions['entity.plan.add_page']);
  unset($local_actions['farm.actions:farm.add.log.bundle']);
}

/**
 * Implements hook_farm_dashboard_panes().
 */
function farm_nfa_farm_dashboard_panes() {
  return [
    'dashboard_assets_search' => [
      'title' => t('Assets'),
      'block' => 'farm_nfa_dashboard_search_form_block',
      'region'  => 'first',
      'args'  => [
        'route' => 'entity.asset.collection',
        'entity_type' => 'asset'
      ],
    ],
    'dashboard_plans_search' => [
      'title' => t('Plans'),
      'block' => 'farm_nfa_dashboard_search_form_block',
      'region'  => 'second',
      'args'  => [
        'route' => 'entity.plan.collection',
        'entity_type' => 'plan'
      ],
    ],
  ];
}

/**
 * Implements hook_form_alter().
 */
function farm_nfa_form_alter(&$form,FormStateInterface $form_state) {
  $build_info = $form_state->getBuildInfo();
  if (isset($build_info['base_form_id']) && $build_info['base_form_id'] == 'log_confirm_form') {
    // Do not ajaxify outside the off canvas.
    $request_stack = \Drupal::requestStack();
    $current_request = $request_stack->getCurrentRequest();
    if ($current_request->request->get('_drupal_ajax') != 1) {
      return;
    }
    $form['actions']['submit']['#ajax'] = [
      'callback' => 'farm_nfa_confirm_form_ajax_helper',
    ];
    $log_types = $request_stack->getParentRequest()->query->get('log_types');
    $form_state->set('log_types', $log_types);
    $form['actions']['cancel'] = [
      '#type' => 'button',
      '#value' => t('Cancel'),
      '#button_type' => 'danger',
      '#ajax' => [
        'callback' => 'farm_nfa_confirm_form_cancel_ajax_helper',
      ],
      '#weight' => 10,
    ];
  }
}

/**
 * Reload the log listing after deleting.
 *
 * @return \Drupal\Core\Ajax\AjaxResponse
 */
function farm_nfa_confirm_form_ajax_helper($form, FormStateInterface $form_state) {
  $response = new AjaxResponse();
  if ($plan = \Drupal::service('farm_nfa.referer_plan_loader')->load()) {
    $assets = $plan->get('asset')->referencedEntities();
    $asset = reset($assets);
    $log_types = $form_state->get('log_types');
    $view = views_embed_view('plan_logs', 'embed', $asset->id(), implode('+', $log_types));
    $response->addCommand(new ReplaceCommand('.view-plan-logs', $view));
    $form['#attached']['library'][] = 'farm_nfa/off_canvas';
    $response->setAttachments($form['#attached']);
    $response->addCommand(new MessageCommand(t('The task has been deleted.')));
  }

  $response->addCommand(new CloseDialogCommand('#drupal-off-canvas'));
  return $response;
}

/**
 * Replaces the cancel link by a button that closes the dialog.
 *
 * @return \Drupal\Core\Ajax\AjaxResponse
 */
function farm_nfa_confirm_form_cancel_ajax_helper($form, FormStateInterface $form_state) {
  $response = new AjaxResponse();
  $response->addCommand(new CloseDialogCommand('#drupal-off-canvas'));
  return $response;
}

/**
 * Implements hook_theme_registry_alter().
 */
function farm_nfa_theme_registry_alter(&$theme_registry) {
  // Override the farm_ui layout to use layout builder instead.
  if (isset($theme_registry['plan__full']['preprocess functions'])) {
    $theme_registry['plan__full']['preprocess functions'] = array_filter($theme_registry['plan__full']['preprocess functions'], fn($f) => $f != 'farm_ui_theme_preprocess_plan__full');
  }
}

/**
 * Implements hook_entity_base_field_info_alter().
 */
function farm_nfa_entity_base_field_info_alter(&$fields, EntityTypeInterface $entity_type) {
  if ($entity_type->id() == 'log') {
    $fields['location']->addConstraint('DuplicateReference');
  }
}
